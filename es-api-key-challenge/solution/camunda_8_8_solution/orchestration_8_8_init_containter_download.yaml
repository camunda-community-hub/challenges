---
orchestration:
  # Shared volume where the initContainer drops the plugin JAR
  extraVolumes:
    - name: es-api-plugin
      emptyDir: {}
  # Mount the populated JAR into the main orchestration container
  extraVolumeMounts:
    - name: es-api-plugin
      mountPath: /usr/local/plugin/es-api-key-plugin.jar
      subPath: es-api-key-plugin.jar
  # Init container: downloads the plugin JAR into the shared volume
  initContainers:
    - name: init-es-api-plugin
      image: curlimages/curl:8.6.0
      imagePullPolicy: IfNotPresent
      command: ["/bin/sh", "-c"]
      args:
        - set -e
        - echo "Downloading ES API Key plugin JAR..."
        - >
          curl -fL
          https://raw.githubusercontent.com/camunda-community-hub/challenges/es-api-key-challenge/es-api-key-challenge/solution/plugin/target/es-api-key-header-plugin-1.0.0.jar
          -o /plugins/es-api-key-plugin.jar
        - echo "Download completed"
      volumeMounts:
        - name: es-api-plugin
          mountPath: /plugins

  #   Use Alpine and install curl
  #   initContainers:
  #     - name: init-es-api-plugin
  #       image: alpine:3.19
  #       imagePullPolicy: IfNotPresent
  #       command: ["/bin/sh", "-c"]
  #       args: |
  #         set -e
  #         apk add --no-cache curl
  #         echo "Downloading ES API Key plugin JAR..."
  #         curl -fL \
  #           https://raw.githubusercontent.com/camunda-community-hub/challenges/es-api-key-challenge/es-api-key-challenge/solution/plugin/target/es-api-key-header-plugin-1.0.0.jar \
  #           -o /plugin/es-api-key-plugin.jar
  #         echo "Download completed"
  #       volumeMounts:
  #         - name: es-api-plugin
  #           mountPath: /plugin
  env:
    # Operate importer → Zeebe Elasticsearch
    - name: CAMUNDA_OPERATE_ZEEBEELASTICSEARCH_INTERCEPTORPLUGINS_0_ID
      value: es-api-key
    - name: CAMUNDA_OPERATE_ZEEBEELASTICSEARCH_INTERCEPTORPLUGINS_0_CLASSNAME
      value: com.example.camunda.optimize.es.ElasticApiKeyHeaderPlugin
    - name: CAMUNDA_OPERATE_ZEEBEELASTICSEARCH_INTERCEPTORPLUGINS_0_JARPATH
      value: /usr/local/plugins/es-api-key-plugin.jar

    # Operate → Elasticsearch client
    - name: CAMUNDA_OPERATE_ELASTICSEARCH_INTERCEPTORPLUGINS_0_ID
      value: es-api-key
    - name: CAMUNDA_OPERATE_ELASTICSEARCH_INTERCEPTORPLUGINS_0_CLASSNAME
      value: com.example.camunda.optimize.es.ElasticApiKeyHeaderPlugin
    - name: CAMUNDA_OPERATE_ELASTICSEARCH_INTERCEPTORPLUGINS_0_JARPATH
      value: /usr/local/plugins/es-api-key-plugin.jar

    # Tasklist importer → Zeebe Elasticsearch
    - name: CAMUNDA_TASKLIST_ZEEBEELASTICSEARCH_INTERCEPTORPLUGINS_0_ID
      value: es-api-key
    - name: CAMUNDA_TASKLIST_ZEEBEELASTICSEARCH_INTERCEPTORPLUGINS_0_CLASSNAME
      value: com.example.camunda.optimize.es.ElasticApiKeyHeaderPlugin
    - name: CAMUNDA_TASKLIST_ZEEBEELASTICSEARCH_INTERCEPTORPLUGINS_0_JARPATH
      value: /usr/local/plugins/es-api-key-plugin.jar

    # Tasklist → Elasticsearch client
    - name: CAMUNDA_TASKLIST_ELASTICSEARCH_INTERCEPTORPLUGINS_0_ID
      value: es-api-key
    - name: CAMUNDA_TASKLIST_ELASTICSEARCH_INTERCEPTORPLUGINS_0_CLASSNAME
      value: com.example.camunda.optimize.es.ElasticApiKeyHeaderPlugin
    - name: CAMUNDA_TASKLIST_ELASTICSEARCH_INTERCEPTORPLUGINS_0_JARPATH
      value: /usr/local/plugins/es-api-key-plugin.jar

    # Elasticsearch API key
    - name: ES_API_KEY_B64
      valueFrom:
        secretKeyRef:
          name: es-api-key
          key: ES_API_KEY_B64